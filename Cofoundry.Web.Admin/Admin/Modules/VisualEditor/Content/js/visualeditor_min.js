angular.module("cms.visualEditor",["cms.shared"]).constant("_",window._).constant("visualEditor.modulePath","/Admin/Modules/VisualEditor/Js/");
angular.module("cms.visualEditor").factory("visualEditor.pageBlockService",["$http","shared.serviceBase","visualEditor.options",function(o,t,n){var e={},r=t+"page-version-region-blocks",u=t+"custom-entity-version-page-blocks";function i(e,t){return c(e)+"/"+t}function c(e){return e?u:r}return e.getAllBlockTypes=function(){return o.get(t+"page-block-types/")},e.getPageVersionBlockById=function(e,t){return o.get(i(e,t)+"?datatype=updatecommand")},e.getRegion=function(e){return o.get(t+"page-templates/0/regions/"+e)},e.getBlockTypeSchema=function(e){return o.get(t+"page-block-types/"+e)},e.add=function(e,t){return t[(e?"customEntity":"page")+"VersionId"]=n.versionId,o.post(c(e),t)},e.update=function(e,t,n){return o.put(i(e,t),n)},e.remove=function(e,t){return o.delete(i(e,t))},e.moveUp=function(e,t){return o.put(i(e,t)+"/move-up")},e.moveDown=function(e,t){return o.put(i(e,t)+"/move-down")},e}]);
angular.module("cms.visualEditor").controller("AddBlockController",["$scope","$q","_","shared.LoadState","visualEditor.pageBlockService","visualEditor.options","options","close",function(o,e,t,a,l,n,d,c){function p(){o.submitLoadState.on(),l.add(d.isCustomEntity,o.command).then(d.refreshContent).then(i).finally(o.submitLoadState.off)}function i(){c(),d.onClose()}function s(e){2===(o.currentStep=e)&&(o.formLoadState.on(),l.getBlockTypeSchema(o.command.pageBlockTypeId).then(function(e){e.defaultValue&&e.defaultValue.value&&t.defaults(o.command.dataModel,angular.copy(e.defaultValue.value)),o.formDataSource={modelMetaData:e,model:o.command.dataModel},o.templates=e.templates,o.formLoadState.off()}))}function m(e){o.command.pageBlockTypeId=e&&e.pageBlockTypeId}function r(e){m(e),s(2)}function u(e){return e&&e.pageBlockTypeId===o.command.pageBlockTypeId}d.anchorElement,o.command={dataModel:{},pageId:d.pageId,pageTemplateRegionId:d.pageTemplateRegionId,pageVersionId:n.pageVerisonId,adjacentVersionBlockId:d.adjacentVersionBlockId,insertMode:d.insertMode||"Last"},o.submitLoadState=new a,o.formLoadState=new a(!0),o.save=p,o.close=i,o.selectBlockType=m,o.selectBlockTypeAndNext=r,o.isBlockTypeSelected=u,o.setStep=s,s(1),l.getAllBlockTypes().then(function(e){o.title=d.regionName,d.permittedBlockTypes.length?o.blockTypes=t.filter(e,function(e){return t.contains(d.permittedBlockTypes,e.fileName)}):o.blockTypes=e,1===o.blockTypes.length?(o.command.pageBlockTypeId=o.blockTypes[0].pageBlockTypeId,s(2)):o.allowStep1=!0,o.formLoadState.off()})}]);
angular.module("cms.visualEditor").controller("EditBlockController",["$scope","$q","_","shared.LoadState","visualEditor.pageBlockService","visualEditor.options","options","close",function(a,n,o,t,l,e,d,i){function c(){a.submitLoadState.on(),l.update(d.isCustomEntity,d.versionBlockId,a.command).then(d.refreshContent).then(s).finally(a.submitLoadState.off)}function s(){i(),d.onClose()}d.anchorElement,a.command={dataModel:{},pageId:d.pageId},a.submitLoadState=new t,a.formLoadState=new t(!0),a.save=c,a.close=s,function(){var o,t,e={};a.formLoadState.on(),o=l.getBlockTypeSchema(d.pageBlockTypeId).then(function(o){a.templates=o.templates,e.modelMetaData=o}),t=l.getPageVersionBlockById(d.isCustomEntity,d.versionBlockId).then(function(o){a.command=o,e.model=o.dataModel}),n.all([o,t]).then(function(){a.formDataSource=e,a.formLoadState.off()})}()}]);
angular.module("cms.visualEditor").controller("VisualEditorController",["$window","$scope","_","shared.LoadState","shared.entityVersionModalDialogService","shared.modalDialogService","shared.localStorage","visualEditor.pageBlockService","visualEditor.modulePath","shared.urlLibrary","visualEditor.options",function(t,o,a,e,n,i,l,s,r,d,c){var u,f,p=this,m=(t.document,new e);function h(o){o.data.action&&p[o.data.action]&&p[o.data.action].apply(this,o.data.args)}function g(){u={entityNameSingular:c.entityNameSingular,isCustomEntity:c.isCustomEntityRoute}}function k(o){n.publish(o.entityId,b,u).then(L).catch(S)}function B(o){n.unpublish(o.entityId,b,u).then(L).catch(S)}function v(o){n.copyToDraft(o.entityId,o.versionId,o.hasDraftVersion,b,u).then(L).catch(S)}function y(o){i.show({templateUrl:r+"Routes/Modals/AddBlock.html",controller:"AddBlockController",options:{insertMode:o.insertMode,pageTemplateRegionId:o.pageTemplateRegionId,adjacentVersionBlockId:o.versionBlockId,permittedBlockTypes:o.permittedBlockTypes,isCustomEntity:o.isCustomEntity,regionName:o.regionName,pageId:o.pageId,onClose:function(){m.off()},refreshContent:w}})}function I(o){m.isLoading||(m.on(),i.show({templateUrl:r+"Routes/Modals/AddBlock.html",controller:"AddBlockController",options:{pageTemplateRegionId:o.pageTemplateRegionId,adjacentVersionBlockId:o.versionBlockId,permittedBlockTypes:o.permittedBlockTypes,insertMode:o.insertMode,refreshContent:w,isCustomEntity:o.isCustomEntity,pageId:o.pageId,onClose:function(){m.off()}}}))}function C(o){m.isLoading||(m.on(),i.show({templateUrl:r+"Routes/Modals/EditBlock.html",controller:"EditBlockController",options:{versionBlockId:o.versionBlockId,pageBlockTypeId:o.pageBlockTypeId,isCustomEntity:o.isCustomEntity,refreshContent:w,onClose:function(){m.off()}}}))}function E(o){var t=o.isUp?s.moveUp:s.moveDown;m.isLoading||(m.on(),t(o.isCustomEntity,o.versionBlockId).then(w).finally(m.off))}function T(o){var t=o.isCustomEntity,e={title:"Delete Block",message:"Are you sure you want to delete this content block?",okButtonTitle:"Yes, delete it",onOk:function(){return s.remove(t,o.versionBlockId).then(w).finally(m.off)},onCancel:function(){m.off()}};m.isLoading||(m.on(),i.confirm(e))}function w(){t.parent.location=t.parent.location}function L(){var o=function(o,e){var t=o.match(/(.+)(?:\?)([^#\s]*)(#.*|)/i),n=[],i="";if(!t)return o;a.each(t[2].split("&"),function(t){t&&a.every(e,function(o){return-1===t.indexOf(o+"=")})&&n.push(t)}),n.length&&(i="?"+n.join("&"));return o=t[1]+i+t[3]}(t.parent.location.href,["version","mode"]);t.parent.location=o}function b(o){p.globalLoadState.on()}function S(o){p.globalLoadState.off()}f=t.addEventListener?"addEventListener":"attachEvent",(0,window[f])("attachEvent"==f?"onmessage":"message",h),p.globalLoadState=m,p.config=g,p.publish=k,p.unpublish=B,p.copyToDraft=v,p.addRegionBlock=y,p.addBlock=I,p.addBlockAbove=I,p.addBlockBelow=I,p.editBlock=C,p.moveBlockUp=E,p.moveBlockDown=E,p.deleteBlock=T}]);