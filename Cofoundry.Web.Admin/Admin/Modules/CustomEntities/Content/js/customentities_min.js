angular.module("cms.customEntities",["ngRoute","cms.shared"]).constant("_",window._).constant("customEntities.modulePath","/Admin/Modules/CustomEntities/Js/");
angular.module("cms.customEntities").config(["$routeProvider","shared.routingUtilities","customEntities.modulePath",function(t,i,e){i.registerCrudRoutes(t,e,"CustomEntity")}]);
angular.module("cms.customEntities").controller("ChangeOrderingController",["$scope","$q","$location","_","shared.LoadState","shared.arrayUtilities","shared.internalModulePath","shared.modalDialogService","shared.customEntityService","customEntities.options","options","close",function(o,t,e,n,i,a,r,d,c,l,s,f){var m="customEntityId";function u(){o.command.orderedCustomEntityIds=L(),o.submitLoadState.on(),c.updateOrdering(o.command).then(s.onSave).then(f).finally(o.submitLoadState.off)}function g(){o.formLoadState.off()}function S(t,e){a.moveObject(o.gridData,e,t,m)}function D(t){a.removeObject(o.gridData,t)}function h(){d.show({templateUrl:r+"UIComponents/CustomEntities/CustomEntityPickerDialog.html",controller:"CustomEntityPickerDialogController",options:{selectedIds:L(),customEntityDefinition:l,filter:{localeId:o.command.localeId},onSelected:function(e){{var t;e&&e.length?(t=n.filter(o.gridData,function(t){return!n.contains(e,t[m])}),o.gridData=n.difference(o.gridData,t),(t=n.difference(e,L())).length&&(o.gridLoadState.on(),c.getByIdRange(t).then(function(t){o.gridData=n.union(o.gridData,t),o.gridLoadState.off()}))):o.gridData=[]}}}})}function L(){return n.pluck(o.gridData,m)}function p(t){2===(o.currentStep=t)&&function(){o.formLoadState.on();var t={pageSize:60,localeId:o.command.localeId,interpretNullLocaleAsNone:!0};c.getAll(t,l.customEntityDefinitionCode).then(function(t){o.isPartialOrdering?o.gridData=n.filter(t.items,function(t){return!!t.ordering}):o.gridData=t.items,o.formLoadState.off()})}()}o.options=l,o.command={localeId:s.localeId,customEntityDefinitionCode:l.customEntityDefinitionCode},o.isPartialOrdering="Partial"===l.ordering,o.submitLoadState=new i,o.formLoadState=new i(!0),o.gridLoadState=new i,o.save=u,o.close=f,o.setStep=p,o.onLocalesLoaded=g,o.onDrop=S,o.remove=D,o.showPicker=h,l.hasLocale?(o.allowStep1=!0,p(1)):(p(2),o.formLoadState.off())}]);
angular.module("cms.customEntities").controller("ChangeUrlController",["$scope","$q","$location","shared.LoadState","shared.customEntityService","customEntities.options","options","close",function(o,t,e,a,l,n,s,c){var i,d=t.defer();function u(){o.submitLoadState.on(),l.updateUrl(o.command).then(s.onSave).then(c).finally(o.submitLoadState.off)}i=s.customEntity,o.options=n,o.customEntity=i,o.command={customEntityId:i.customEntityId,localeId:i.locale?i.locale.localeId:void 0,urlSlug:i.urlSlug},o.submitLoadState=new a,o.formLoadState=new a(n.hasLocale),o.save=u,o.close=c,o.localesLoaded=d.resolve,o.formLoadState.offWhen(d)}]);
angular.module("cms.customEntities").controller("DuplicateCustomEntityController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.customEntityService","customEntities.options","options","close",function(o,t,e,n,i,a,l,c,s){var u=t.defer();function d(){o.command.urlSlug=n.slugify(o.command.title)}function m(){o.submitLoadState.on(),a.duplicate(o.command).then(r).then(s).finally(o.submitLoadState.off)}function r(t){e.path("/"+t)}(function(){var t=c.customEntity;o.customEntity=t,o.command={customEntityToDuplicateId:t.customEntityId,localeId:t.locale?t.locale.localeId:void 0,title:"Copy of "+t.latestVersion.title},d()})(),o.submitLoadState=new i,o.formLoadState=new i(l.hasLocale),o.customEntityDefinition=l,o.save=m,o.close=s,o.onTitleChanged=d,o.localesLoaded=u.resolve,o.formLoadState.offWhen(u)}]);
angular.module("cms.customEntities").controller("AddCustomEntityController",["$scope","$location","$q","$window","shared.stringUtilities","shared.LoadState","shared.customEntityService","shared.urlLibrary","customEntities.options",function(o,n,t,a,e,i,d,l,u){var c=this;function s(t,n){var o=t?(c.command.publish=!0,c.saveAndPublishLoadState):c.saveLoadState;t=o,c.globalLoadState.on(),t&&_.isFunction(t.on)&&t.on(),d.add(c.command,u.customEntityDefinitionCode).then(n).finally(function(t){c.globalLoadState.off(),t&&_.isFunction(t.off)&&t.off()}.bind(null,o))}function m(){c.command.urlSlug=e.slugify(c.command.title)}function f(){n.path("/")}function r(t){n.path("/"+t)}function h(n){return d.getById(n).then(function(t){t=l.customEntityVisualEditor(t,!0);t?a.location.href=t:r(n)})}c.globalLoadState=new i,c.saveLoadState=new i,c.saveAndPublishLoadState=new i,c.formLoadState=new i(!0),c.editMode=!1,c.options=u,c.saveButtonText=u.autoPublish?"Save":"Save & Publish",c.saveAndEditButtonText=u.autoPublish?"Save & Edit Content":"Save Draft & Edit Content",c.save=s.bind(null,!1,r),c.saveAndPublish=s.bind(null,!0,r),c.saveAndEdit=s.bind(null,!1,h),c.cancel=f,c.onNameChanged=m,function(){c.command={};var t=d.getDataModelSchema(u.customEntityDefinitionCode).then(function(t){t.defaultValue&&t.defaultValue.value?c.command.model=angular.copy(t.defaultValue.value):c.command.model={};c.formDataSource={model:c.command.model,modelMetaData:t}}),n=d.getPageRoutes(u.customEntityDefinitionCode).then(function(t){c.pageRoutes=t});c.formLoadState.offWhen(t,n),o.$watch("vm.command.localeId",function(t){c.additionalParameters=t?{localeId:t}:{}})}()}]);
angular.module("cms.customEntities").controller("CustomEntityDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.customEntityService","shared.urlLibrary","shared.permissionValidationService","customEntities.modulePath","customEntities.options",function(e,n,t,o,i,a,s,u,l,r,c,d,m){var h,f=this,y=m.nameSingular.toLowerCase(),b={entityNameSingular:m.nameSingular,isCustomEntity:!0};function E(){f.editMode=!0,f.mainForm.formStatus.clear()}function S(t){t=t?(f.updateCommand.publish=!0,f.saveAndPublishLoadState):f.saveLoadState;O(t),l.updateDraft(f.updateCommand,m.customEntityDefinitionCode).then(M.bind(null,"Changes were saved successfully")).finally(R.bind(null,t))}function p(){f.editMode=!1,f.updateCommand=B(f.customEntity),f.mainForm.formStatus.clear()}function v(){u.publish(f.customEntity.customEntityId,O,b).then(M.bind(null,m.nameSingular+" published successfully.")).catch(R)}function g(){u.unpublish(f.customEntity.customEntityId,O,b).then(M.bind(null,"The "+y+" has been unpublished and reverted to draft state.")).catch(R)}function C(){var t={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since it was last published.",okButtonTitle:"Yes, discard it",onOk:function(){return O(),l.removeDraft(f.customEntity.customEntityId)}};s.confirm(t).then(M.bind(null,"Draft discarded successfully"))}function D(t){u.copyToDraft(f.customEntity.customEntityId,t.customEntityVersionId,f.customEntity.hasDraftVersion,O,b).then(function(){M("Draft created successfully.")}).catch(R)}function L(){s.show({templateUrl:d+"Routes/Modals/DuplicateCustomEntity.html",controller:"DuplicateCustomEntityController",options:{customEntity:f.customEntity}})}function P(){var t={title:"Delete "+m.nameSingular,message:"Are you sure you want to delete this "+y+"?",okButtonTitle:"Yes, delete it",onOk:function(){return O(),l.remove(f.customEntity.customEntityId).then(A).catch(R)}};s.confirm(t)}function w(){s.show({templateUrl:d+"Routes/Modals/ChangeUrl.html",controller:"ChangeUrlController",options:{customEntity:f.customEntity,onSave:M.bind(null,"Url Changed")}})}function U(t){return c.hasPermission(m.customEntityDefinitionCode+t)}function M(t,e){return V(e).then(f.mainForm.formStatus.success.bind(null,t))}function V(t){return n.all([l.getById(e.id),F(),l.getDataModelSchema(m.customEntityDefinitionCode)]).then(function(t){var e=t[0],n=t[1];h=t[2],T(f.customEntity=e,n),f.updateCommand=B(e),f.isMarkedPublished="Published"==f.customEntity.publishStatus,f.publishStatusLabel=k(e),f.customEntity.locale?f.additionalParameters={localeId:f.customEntity.locale.localeId}:f.additionalParameters={};f.editMode=!1}).then(R.bind(null,t))}function I(){return f.versionsLoadState.on(),F().then(function(t){T(f.customEntity,t)}).then(R.bind(null,f.versionsLoadState))}function F(){return l.getVersionsByCustomEntityId(e.id,f.versionsQuery.getParameters())}function T(e,t){e.latestVersion.pages[0];var n=e.isPublished();o.each(t.items,function(t){t.versionLabel=function(t,e){if("Draft"==t.workFlowStatus)return t.workFlowStatus;var n="V"+t.displayVersion;return t.isLatestPublishedVersion?n+" ("+k(e)+")":n}(t,e),t.browseUrl=f.urlLibrary.visualEditorForVersion(e,t,!0,n)}),f.versions=t}function k(t){return"Published"==t.publishStatus&&t.publishDate<Date.now()?"Pending Publish":t.publishStatus}function B(t){t={customEntityId:t.customEntityId,title:t.latestVersion.title,model:angular.copy(t.latestVersion.model)};return f.formDataSource={model:t.model,modelMetaData:h},t}function A(){t.path("")}function O(t){f.globalLoadState.on(),t&&o.isFunction(t.on)&&t.on()}function R(t){f.globalLoadState.off(),t&&o.isFunction(t.off)&&t.off()}f.edit=E,f.save=S.bind(null,!1),f.saveAndPublish=S.bind(null,!0),f.cancel=p,f.publish=v,f.unpublish=g,f.discardDraft=C,f.copyToDraft=D,f.duplicate=L,f.deleteCustomEntity=P,f.changeUrl=w,f.editMode=!1,f.globalLoadState=new i,f.saveLoadState=new i,f.saveAndPublishLoadState=new i,f.formLoadState=new i(!0),f.versionsLoadState=new i,f.options=m,f.urlLibrary=r,f.saveButtonText=m.autoPublish?"Save":"Save & Publish",f.canChangeUrl=!m.autoGenerateUrlSlug||m.hasLocale,f.versionsQuery=new a({onChanged:I,useHistory:!1,defaultParams:{pageSize:6}}),f.canPublish=U("CMEPUB"),f.canUpdateUrl=U("UPDURL"),f.canDelete=U("COMDEL"),f.canUpdate=U("COMUPD"),f.canCreate=U("COMCRT"),V(f.formLoadState)}]);
angular.module("cms.customEntities").controller("CustomEntityListController",["$q","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.customEntityService","shared.permissionValidationService","shared.ModelPreviewFieldset","shared.ImagePreviewFieldCollection","customEntities.modulePath","customEntities.options",function(i,t,e,n,o,r,s,a,l,d,c){var u=this;function g(e){u.isFilterVisible=t.isUndefined(e)?!u.isFilterVisible:e}function m(){o.show({templateUrl:d+"Routes/Modals/ChangeOrdering.html",controller:"ChangeOrderingController",options:{localeId:u.filter.localeId,onSave:C}})}function h(){g(!1),C()}function f(e){return s.hasPermission(c.customEntityDefinitionCode+e)}function C(){var e,t=(u.gridLoadState.on(),r.getAll(u.query.getParameters(),c.customEntityDefinitionCode).then(function(e){u.result=e,u.gridLoadState.off()}));return u.previewFields?(e=i.defer()).resolve():e=r.getDataModelSchema(c.customEntityDefinitionCode).then(function(e){u.previewFields=new a(e)}),i.all([e,t]).then(function(){return u.gridImages=new l,u.gridImages.load(u.result.items,u.previewFields)})}u.options=c,u.gridLoadState=new e,u.query=new n({onChanged:h}),u.filter=u.query.getFilters(),u.toggleFilter=g,u.changeOrdering=m,u.permissions=s,u.canUpdate=f("COMUPD"),u.canCreate=f("COMCRT"),g(!1),C()}]);